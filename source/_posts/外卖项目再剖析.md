---
title: 外卖项目再剖析
date: 2024-01-14 22:00:24
tags: springboot
---

## 前言

对于之前只是跟着敲着的外卖项目，以为很简单，什么都做完了，结果最近重新运行很多功能都没完成，还是有很多不懂的地方，我果然还是太菜了，现在尝试增加和优化功能

## 遇到的问题

想着修改前端，美化一下，毕竟只有一个手机号短信验证登录，太简单了，网上找了一个前端登录注册页面，但是拿来用时，老是遇到很多问题

### 前端接受的响应问题

F12查看返回结果，是没问题的，但是前端的代码：

<!-- more -->

```html
loginBtnEl.addEventListener('click', function () {
        axios.post('/user/login', { username: usernameInput.value, password: passwordInput.value })
            .then(function (response) {
                if(response.code){
                    alert("success");
                    alert(response.code);
                }
                if (response.data) {
                    // 验证成功，跳转到其他页面
                    // window.location.href = '/front/index.html';
                    }

                } else {
                    // 验证失败，提示用户
                    alert("debug");
                    alert(response);
                }
                alert(response)
            })
            .catch(function (error) {
                alert("qqqq")

                console.log(error);
                console.log("error");
            });
    });
```

中response.code老是找不到，既没能跳转到写的if(response.code===1);但是response.data却可以，后来在控制台打印才知道，后端返回的数据都是response的data,毕竟response还有statue(200,404等）,headers等，靠，花了我好久的时间
### 前端代码没反应
对于js这种解释执行的语言，一旦前面的代码出了问题，后面就不会执行，导致我debug老是没反应，知道这一点也是从浏览器的报错信息知道的，靠



### redis缓存问题

服了啊，为了探究threadlocal是不是线程独立的，打了个端点研究

```
@GetMapping("/list")
@Cacheable(value = "dishCache",key = "#dish.categoryId+'_'+#dish.status")//我是笨蛋，这里的键怎么能是dish.id当然是categoryid啦
public Result<List<DishDto>> list(DishDto dish){

    Long threadLocal = BaseContext.getThreadLocal();
    System.out.println("当前用户id为------------------------>"+threadLocal);//断点处

    if(threadLocal != null){
        System.out.println("当前用户id为"+threadLocal);
    }
    threadLocal = BaseContext.getThreadLocal();

    System.out.println("当前用户id为0-0----------------------->"+threadLocal);//断点处
    int i=10000;
    while (i!=0){
        i=i-1;
        System.out.println("debug................");
    }
```

结果这个断点有时候能捕捉到，有时候捕捉不到，原因竟然是开启了缓存，即@Cacheable这个注解导致有缓存时就会运行到断点处的代码段，没有缓存时就能运行到断点处，弄得我懵了好久，差不多花了一个40分钟找这个BUG

## 优化的地方

保存每一个会话的threadlocal对于单体应用或单台服务器还可以，但是如果是多台服务器的话，就会存在一个问题，
使用Session存储用户信息就会出现问题，因为用户的请求可能会被分配到不同的服务器上，
导致Session信息无法共享。这时候，就需要使用外部缓存（例如Redis）来共享用户信息，
以便用户在多个服务器之间进行无缝切换。
所以可以考虑使用redis优化

